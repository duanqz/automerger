<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AutoMerger Flows</title>
    <link rel="stylesheet" href="css/base.css"/>
    <link rel="stylesheet" href="css/react-json.css"/>
    <link rel="stylesheet" href="css/bootstrap.min.css"/>
    <script src="js/react.js"></script>
    <script src="js/react-dom.js"></script>
    <script src="js/jquery-2.2.3.min.js"></script>
    <script src="js/jquery.cookie.js"></script>
    <script src="js/browser.min.js"></script>
    <script src="js/diff.js"></script>
    <script src="js/bootstrap.min.js"></script>
</head>
<body>
<h1>AutoMerger Flows Configuration</h1>

<div id="container"></div>

<script type="text/babel">

    /** 代码仓库中路径选择与读取*/
    const CONFIG_TYPES = [
        'meizu',
        'odc',
        'archermind',
        'intl',
        'tv'
    ];
    var curSelected = 'meizu';

    const PROJECT_ID = 51;
    const BRANCH = 'master';
    const COOKIE_EXPIRE_DAYS = 30;
    const COOKIE_KEY_LOGIN_USER = 'login_user';

    /** 获取gitlab接口数据*/
    const URL_GITLAB_BASE = 'http://gitlab.meizu.com';
    const URL_GITLAB_BASE_API = `${URL_GITLAB_BASE}/api/v3`;
    const URL_GITLAB_FILE = `${URL_GITLAB_BASE_API}/projects/${PROJECT_ID}/repository/files`;
    const GET_FILE_NAME = '/flows.json';
    const URL_GITLAB_SESSION = `${URL_GITLAB_BASE_API}/session`;
    const URL_GITLAB_USER = `${URL_GITLAB_BASE}/u/`;

    var globalUserInfo = null;

    /** 编辑框与label文本之间的切换*/
    var editableViews = [];

    var addEditable = function (editable) {
        editableViews.push(editable);
    }

    var closeEditables = function () {
        editableViews.map((editable)=> {
            if (editable && editable.isMounted() && editable.closeEditable) {
                editable.closeEditable();
            }
        });
    }


    /** 批量选择模态对话框的全局绑定
     * 可以批量输入repoName进行批量选择*/
    var selectModalFunc = null;
    $('#selectModalOk').click(()=> {
        let inputCtrl = $('#selectModalContent');
        let inputText = inputCtrl.val().trim();
        if (inputText !== '') {
            var inputArr = inputText.split("\n");
            selectModalFunc && selectModalFunc(inputArr);
            $('#selectModal').modal('hide');
            inputCtrl.val('');
        } else {
            alert('输入不能为空,请重新输入!');
        }
    });



    /** 批量操作模态对话框的全局绑定*/
    var modalType = '';
    var addModalFunc = null;
    var deleteModalFunc = null;
    var modalSelectionChange = null;

    /** 批量操作模态对话框提交事件*/
    $('#myModalCommit').click(()=> {
        let [upstreamCtrl, downstreamCtrl] = [$('#myModalUpStream'), $('#myModalDownStream')];
        let [textUp, textDown] = [upstreamCtrl.val().trim(), downstreamCtrl.val().trim()];
        if (textUp !== '' && textDown !== '') {
            $('#myModal').modal('hide');
            if (modalType === '添加分支') {
                addModalFunc(textUp, textDown);
            } else {
                deleteModalFunc(textUp, textDown);
            }
            upstreamCtrl.val('');
            downstreamCtrl.val('');
        } else {
            alert('输入不能为空,请重新输入!');
        }
    });

    /** 批量操作模态对话框选择改编事件*/
    $('#myModalSelect').change((event)=> {
        modalSelectionChange(event)
    });


    /** 从服务器载入最初始的内容*/
    var originContent = '';
    /** 当前的json字符串*/
    var curContent = '';


    /** Gitlab相关变量*/
    var gitlabCommitFunc = null;
    /** Gitlab提交信息模态框*/
    $('#commitModalOk').click((event)=> {
        event.preventDefault();
        let logCtrl = $('#commitModalLog');
        let log = logCtrl.val().trim();
        if (log === '') {
            alert('提交日志不能为空,请重新输入!');
        } else {
            //log不为空,则提交修改
            gitlabCommitFunc(curContent, log);
        }
    });

    /**
     * 定义公共操作的MixIn
     */
    var EditableMixIn = {
        getInitialState: function () {
            return ({
                editable: false,
            });
        },
        componentDidMount() {
            addEditable(this);
        },
        closeEditable() {
            this.setState({
                editable: false,
            });
        },
        changeEditable(event) {
            event && event.preventDefault() && event.stopPropagation();
            let editable = this.state.editable;
            closeEditables();
            this.setState({
                editable: !editable,
            });
        },
    };

    /***
     * 最外层View，根据不同登录态显示不同界面
     */
    var ContainerView = React.createClass({

        getInitialState: function () {
            return {
                login: false
            };
        },

        componentDidMount() {
            /** 先从本地缓存读取用户信息*/
            this.loadUserFromCookie();
        },

        render: function () {
            if (!this.state.login) {
                return (<LoginView onLogin={this.onLogin}/>)
            } else {
                return (<MainView/>);
            }
        },

        /** 登录成功，需要重新刷新界面*/
        onLogin: function () {
            this.setState({
                login: true
            });
        },

        /** 从cookie中读取本地缓存*/
        loadUserFromCookie: function () {
            let userString = $.cookie(COOKIE_KEY_LOGIN_USER);
            if (!userString || userString.trim() === '') {
                return;
            }
            globalUserInfo = JSON.parse(userString);
            if (globalUserInfo) {
                this.setState({
                    login: true
                });
            }
        }
    });


    /** 登录界面
     * 如果用户为登录，则显示此界面
     * */
    var LoginView = React.createClass({

        render: function () {
            return (<center>
                <div className="jumbotron form-horizontal"
                     style={{maxWidth: 480, padding: 80}}>
                    <h2>用户登录</h2>
                    <h4>请使用
                        <a href={URL_GITLAB_BASE}
                           target="view_window">GitLab
                        </a>
                        账号密码登录<br/>账号为工作邮箱前缀
                    </h4>
                    <div className="form-group input-group">
                        <span className="input-group-addon">用户名</span>
                        <input type="text"
                               ref="inputUserName"
                               onKeyDown={this.onUserNameKeyDown}
                               className="form-control"
                               placeholder="输入Gitlab账号"/>
                    </div>
                    <div className="form-group input-group">
                        <span className="input-group-addon">{'密　码'}</span>
                        <input type="password"
                               ref="inputPassword"
                               onKeyDown={this.onPasswordKeyDown}
                               className="form-control"
                               placeholder="输入密码"/>
                    </div>
                    <div className="form-group">
                        <div className="col-sm-offset-2 col-sm-10">
                            <div className="checkbox">
                                <label>
                                    <input type="checkbox" defaultChecked='true'
                                           ref="inputRemember"/>
                                    {`记住我${COOKIE_EXPIRE_DAYS}天`}
                                </label>
                            </div>
                        </div>
                    </div>
                    <div>
                        <button type="submit"
                                className="btn btn-primary"
                                ref="inputLogin"
                                onClick={this.onLoginClick}
                                style={{marginLeft: 60}}>{'登　录'}</button>
                        <button type="submit"
                                onClick={this.onResetClick}
                                className="btn btn-default"
                                style={{marginLeft: 60}}>{'重　置'}</button>
                    </div>
                </div>
            </center>);
        },

        /** 回车键跳到下一个输入框*/
        onUserNameKeyDown: function (event) {
            if (event.keyCode == 13 && this.refs.inputUserName.value != '') {
                this.refs.inputPassword.focus();
            }
        },
        /** 回车键登录*/
        onPasswordKeyDown: function (event) {
            if (event.keyCode == 13 && this.refs.inputPassword.value != '') {
                this.refs.inputLogin.focus();
            }
        },

        /** 当登录成功时*/
        onLoginSucceed: function (userInfo) {
            /** 如果需要缓存登录信息，则保存cookies*/
            if (this.refs.inputRemember.checked) {
                $.cookie(COOKIE_KEY_LOGIN_USER, JSON.stringify(userInfo), {expires: COOKIE_EXPIRE_DAYS});
            } else {
                $.cookie(COOKIE_KEY_LOGIN_USER, JSON.stringify(userInfo));
            }
            globalUserInfo = userInfo;
            this.props.onLogin();
        },

        /**
         * 点击登录按钮
         * @param event
         */
        onLoginClick: function (event) {
            let userName = this.refs.inputUserName.value;
            let password = this.refs.inputPassword.value;
            if (userName === '') {
                this.refs.inputUserName.focus();
                return;
            }
            if (password === '') {
                this.refs.inputPassword.focus();
                return;
            }
            let params = {
                login: userName,
                password: password
            };
            //登录请求
            $.post(URL_GITLAB_SESSION, params).success((response)=> {
                this.onLoginSucceed(response);
            }).error((error)=> {
                let errMsg = error.statusText;
                if (error.status === 401) {
                    errMsg = '验证失败，用户名或密码错了吧！'
                }
                alert(errMsg);
            });
        },

        /**
         * 点击重置按钮
         * @param event
         */
        onResetClick: function (event) {
            this.refs.inputUserName.value = '';
            this.refs.inputPassword.value = '';
        },

    });



    /**
     * 定义主页面
     * */
    var MainView = React.createClass({

        getInitialState: function () {
            return {
                loading: true,
                response: null,
                success: false,
            };
        },

        componentDidMount() {
            this.loadData();
        },

        render: function () {
            return (<div>
                <TopBarView onFileChange={this.onFileChange}/>
                <FlowView success={this.state.success}
                          loading={this.state.loading}
                          response={JSON.parse(this.state.response)}/>
            </div>);
        },

        onFileChange: function () {
            this.loadData();
        },

        loadData: function () {
            this.setState({
                response: null,
                loading: true,
                success: false,
            });
            let params = {
                private_token: globalUserInfo.private_token,
                ref: BRANCH,
                file_path: `config/${curSelected}${GET_FILE_NAME}`
            };
            $.getJSON(URL_GITLAB_FILE, params, (response)=> {
                let content = response.content;
                if (response.encoding && response.encoding === 'base64') {
                    content = window.atob(content);
                }
                originContent = content;
                this.setState({
                    response: content,
                    loading: false,
                    success: true,
                });
            }, (error)=> {
                this.setState({
                    response: null,
                    loading: false,
                    success: false,
                });
            });
        }

    });

    var TopBarView = React.createClass({

        render: function () {
            return (<nav className="navbar navbar-default">
                <div className="btn-group navbar-form navbar-left">
                    <button type="button"
                            className="btn btn-default dropdown-toggle"
                            data-toggle="dropdown">
                        <span ref="refButtonText">{curSelected}</span>
                        <span className="caret"/>
                    </button>
                    <ul className="dropdown-menu">{
                        CONFIG_TYPES.map((item)=> {
                            return (<li key={item}>
                                <a onClick={()=>{this.onItemClick(item)}}>{item}</a>
                            </li>);
                        })
                    }</ul>
                </div>
                <div className="btn-group navbar-form navbar-left">
                    <button onClick={this.onBatchSelectClick}
                            className="btn btn-default">批量选择
                    </button>
                </div>
                <div className="navbar-form navbar-right">
                    <button className="btn btn-danger navbar-right"
                            onClick={this.onLogoutClick}
                            style={{marginRight: 10}}>登出
                    </button>
                </div>
                <a className="navbar-text navbar-right"
                   href={`${URL_GITLAB_USER}${globalUserInfo.username}`}
                   target="view_window">{globalUserInfo.username}</a>
                <div className="navbar-form navbar-right">
                    <img style={{width: 32, height: 32}}
                         src={globalUserInfo.avatar_url}/>
                </div>
            </nav>);
        },

        onBatchSelectClick: function (event) {
            $('#selectModal').modal();
        },


        onItemClick: function (item) {
            this.refs.refButtonText.innerHTML = item;
            if (curSelected !== item) {
                curSelected = item;
                this.props.onFileChange();
            }
        },

        onLogoutClick: function (event) {
            $.cookie(COOKIE_KEY_LOGIN_USER, null);
            location.reload();
        }

    });

    /**
     * 页面顶层布局
     */
    var FlowView = React.createClass({

        getInitialState: function () {
            return {
                changed: false,
            };
        },

        render: function () {
            if (this.props.loading) {
                return <span>Loading...</span>;
            }
            if (this.props.success) {
                let flowObj = this.props.response;
                let showData = [];
                for (let flowList in flowObj) {
                    let flowName = flowObj[flowList];
                    flowName.key = flowList;
                    showData.push(flowName);
                }
                let changed = this.state.changed;
                return (<div>
                    <RepoList data={showData}
                              list={flowObj}
                              changed={changed}
                              onChecked={this.onChecked}
                              onChange={this.refreshList}/>
                </div>);
            } else {
                return <span>Read error!!!</span>;
            }
        },

        onChecked: function () {
            this.setState({});
            closeEditables();
        },

        refreshList: function (data) {
            this.setState({
                changed: true,
            });
        },
    });


    /**
     * 仓库列表布局
     */
    var RepoList = React.createClass({

        componentDidMount() {
            selectModalFunc = this.selectModalFunc;
        },

        render: function () {
            var index = 0;
            return (<center>
                <div style={{maxWidth: 750}}>
                    <table className="table table-striped table-condensed table-bordered">
                        {this.props.data.map((data)=> {
                            return (<FlowRepo data={data}
                                              index={index++}
                                              key={data.key}
                                              list={this.props.list}
                                              onChecked={this.props.onChecked}
                                              onChange={this.props.onChange}/>);
                        })}
                        <RepoAdder list={this.props.list}
                                   onChange={this.props.onChange}/>
                    </table>
                    <FloatBar list={this.props.list}
                              data={this.props.data}
                              onChange={this.props.onChange}
                              changed={this.props.changed}/>
                </div>
            </center>);
        },

        /** 批量导入选中的repo, 参数是需要导入的repo数组*/
        selectModalFunc: function (repoArray) {
            //先重置之前所有选中
            for (let index in this.props.list) {
                let repo = this.props.list[index];
                repo.checked = false;
            }
            //按参数依次选中
            for (let index in repoArray) {
                let key = repoArray[index].trim();
                let repo = this.props.list[key];
                if (repo) {
                    repo.checked = true
                } else if (key !== '') {
                    this.props.list[key] = [];
                    this.props.list[key].checked = true;
                }
            }
            this.props.onChecked();
        },
    });

    /**
     * 底部悬浮窗
     */
    var FloatBar = React.createClass({
        render: function () {
            var hasChecked = false;
            for (var key in this.props.data) {
                if (this.props.data[key].checked) {
                    hasChecked = true;
                    break;
                }
            }
            return (<div className="navbar-fixed-bottom"
                         style={{background:'#F5F5F5', paddingTop: 10}}>
                <div style={{marginBottom: 10, float: 'right'}}>
                    <button onClick={this.onUpClick}
                            style={{marginRight: 10, float: 'right'}}
                            className="btn btn-default">↑Top
                    </button>
                    {this.props.changed &&
                    <button onClick={this.onRefresh}
                            style={{marginRight: 10, float: 'right'}}
                            className="btn btn-info">放弃修改
                    </button>}
                    { this.props.changed &&
                    <JsonSaver list={this.props.list}/>}
                    {hasChecked &&
                    <BatchOperation data={this.props.data}
                                    onChange={this.props.onChange}/>}
                </div>
            </div>);
        },

        onUpClick: function () {
            window.scroll(0, 0);
        },

        onRefresh: function () {
            location.reload();
        }
    });

    /**
     * 批量操作
     * */
    var BatchOperation = React.createClass({

        getInitialState(){
            return ({selection: '添加分支'});
        },

        selArray: [],

        componentDidMount() {
            /** 模态对话框是全局的，所以事件只能添加一次*/
            addModalFunc = this.addModalFunc;
            deleteModalFunc = this.deleteModalFunc;
            modalSelectionChange = this.onTypeChange;
        },

        render: function () {
            var total = 0;
            this.selArray = [];
            for (var key in this.props.data) {
                if (this.props.data[key].checked) {
                    this.selArray.push(this.props.data[key]);
                    total++;
                }
            }
            modalType = this.state.selection;
            var titleText = `您将对选中的${total}个仓库进行${modalType}操作`;
            $('#myModalLabel').html(titleText);
            $('#myModalSelect').val(this.state.selection);
            return (<div style={{marginRight: 10, float: 'right'}}>
                <a href="#myModal"
                   role="button"
                   className="btn"
                   data-toggle="modal">操作选中
                </a>
            </div>);
        },

        onTypeChange: function (event) {
            var value = event.target.value;
            if (this.isMounted()) {
                this.setState({selection: value});
            }
        },

        /** 批量添加分支*/
        addModalFunc: function (textUp, textDown) {
            for (var repo in this.selArray) {
                var branch = {
                    downstream: textDown,
                    upstream: textUp,
                };
                this.selArray[repo].push(branch);
            }
            this.props.onChange();
        },

        /** 批量删除分支*/
        deleteModalFunc: function (textUp, textDown) {
            for (var repo in this.selArray) {
                var branchArr = this.selArray[repo];
                for (var branch in branchArr) {
                    var branchObj = branchArr[branch];
                    if (branchObj.upstream === textUp && branchObj.downstream === textDown) {
                        branchArr.splice(branch, 1);
                    }
                }
            }
            this.props.onChange();
        },
    });

    /**
     * 最后保存json按钮
     */
    var JsonSaver = React.createClass({

        componentDidMount() {
            gitlabCommitFunc = this.jsonSaveCommit;
        },

        render: function () {
            return (<div style={{marginRight: 10, float: 'right'}}>
                <button onClick={this.onJsonSave}
                        className="btn btn-primary">提交修改
                </button>
            </div>);
        },

        /** 点击提交按钮*/
        onJsonSave: function (event) {
            event.preventDefault();
            closeEditables();
            //生成json字符串
            curContent = JSON.stringify(this.props.list, null, 2);
            this.judgeModalDialog(curContent);
        },

        /** 判断是否弹出模态对话框**/
        judgeModalDialog: function (curContent) {

            //判断是否有修改,没有修改则不需要提交
            if (curContent === originContent) {
                alert('没有任何修改,无需提交!');
                return
            }

            let params = {
                private_token: globalUserInfo.private_token,
                ref: BRANCH,
                file_path: `config/${curSelected}${GET_FILE_NAME}`,
            }

            $.getJSON(URL_GITLAB_FILE, params, (response)=> {
                let content = response.content;
                if (response.encoding && response.encoding === 'base64') {
                    content = window.atob(content);
                }
                //为避免强制覆盖,判断在修改过程中远程文件是否发生变化
                if (content !== originContent) {
                    if (confirm('远程文件已发生改动,是否丢弃修改并载入最新版本?')) {
                        location.reload();
                    }
                    return
                }
                this.showCommitModal(curContent);
            }, (error)=> {
                alert(`网络出错[${error}]`);
            });
        },

        /** 显示模态对话框*/
        showCommitModal: function (curContent) {
            //json与源进行diff计算
            let diff = JsDiff.diffLines(originContent, curContent);
            //获取diff显示区域
            let diffPreview = document.getElementById('diffPreview');
            //清空显示区域
            diffPreview.textContent = '';
            //显示diff内容
            diff.forEach(function (part) {
                let color = part.added ? 'GREEN' : part.removed ? 'RED' : '#778899';
                let span = document.createElement('span');
                span.style.color = color;
                if (part.added || part.removed) {
                    span.style.background = '#87CEFF';
                }
                span.appendChild(document.createTextNode(part.value));
                diffPreview.appendChild(span);
            });
            //弹出模态对话框
            $('#commitModalFileName').html(`修改的文件: config/${curSelected}${GET_FILE_NAME}`);
            $('#commitModal').modal();
        },

        /** 提交服务器*/
        jsonSaveCommit: function (submitContent, log) {

            let params = {
                private_token: globalUserInfo.private_token,
                ref: BRANCH,
                file_path: `config/${curSelected}${GET_FILE_NAME}`,
            }

            /** 提交前先拉取服务器最新文件来做对比*/
            $.getJSON(URL_GITLAB_FILE, params, (response)=> {
                let content = response.content;
                if (response.encoding && response.encoding === 'base64') {
                    content = window.atob(content);
                }
                //为避免冲突,判断在修改过程中远程文件是否发生变化
                if (content !== originContent) {
                    if (confirm('远程文件已发生改动,是否丢弃修改并载入最新版本?')) {
                        location.reload();
                    }
                    return
                }

                this.doAjaxCommit(submitContent, log);
            }, (error)=> {
                alert(`网络出错[${error}]`);
            });
        },

        /** 真正做提交请求*/
        doAjaxCommit: function (content, log) {

            //组建提交参数
            let params = {
                private_token: globalUserInfo.private_token,
                branch_name: BRANCH,
                file_path: `config/${curSelected}${GET_FILE_NAME}`,
                encoding: 'text',
                content: content,
                commit_message: log
            };
            //Ajax做PUT提交
            $.ajax({
                type: 'PUT',
                url: URL_GITLAB_FILE,
                data: params,
                success: function (data) {
                    //提交成功后隐藏模态框,刷新页面
                    alert('提交成功了!');
                    let logCtrl = $('#commitModalLog');
                    logCtrl.val('');
                    $('#commitModal').modal('hide');
                    location.reload();
                },
                error: function (msg) {
                    let message = JSON.parse(msg.responseText).message;
                    alert(`提交网络出错[${message}]`);
                }
            });
        }
    });


    /**
     * 添加仓库布局
     */
    var RepoAdder = React.createClass({
        mixins: [EditableMixIn],

        render: function () {
            if (this.state.editable) {
                return (<tbody>
                    <tr>
                        <td colSpan="3">
                            <input type="text"
                                   className="form-control"
                                   ref="inputRepoName"
                                   placeholder="Path of repository"/>
                        </td>
                        <td>
                            <div className="btn-group">
                                <button className="btn btn-success" onClick={this.onRepoOk}>确定</button>
                                <button className="btn btn-default" onClick={this.changeEditable}>取消</button>
                            </div>
                        </td>
                    </tr>
                </tbody>);
            } else {
                return (<tbody>
                    <tr>
                        <td colSpan="4">
                            <button className="btn btn-default" onClick={this.changeEditable}>添加仓库</button>
                        </td>
                    </tr>
                </tbody>);
            }
        },

        /**
         * 编辑Repo名OK
         * @param event
         */
        onRepoOk: function (event) {
            event.preventDefault();
            var txtRepo = this.refs.inputRepoName.value.trim();
            if (txtRepo) {
                this.props.list[txtRepo] = [];
                this.props.onChange(this.props.list);
                this.changeEditable();
            }
        },
    });


    /**
     * 每个仓库布局
     */
    var FlowRepo = React.createClass({
        mixins: [EditableMixIn],

        render: function () {
            return (<tbody>
                <RepoName data={this.props.data}
                          list={this.props.list}
                          index={this.props.index}
                          onChange={this.props.onChange}
                          onChecked={this.props.onChecked}
                          deleteRepo={this.deleteRepo}/>
                {
                    this.props.data.map((branch, index)=> {
                        return (<BranchName data={this.props.data}
                                            key={this.props.data.key + index}
                                            list={this.props.list}
                                            index={index}
                                            onChange={this.props.onChange}
                                            deleteBranch={this.deleteBranch}
                                            branch={branch}/>);
                    })
                }
                {this.renderBranchAdd()}
            </tbody>);
        },

        /**
         * 添加分支布局
         * @returns {XML}
         */
        renderBranchAdd: function () {
            if (this.state.editable) {
                return (<tr>
                    <td>
                        <input type="text"
                               ref="inputUpstream"
                               className="form-control"
                               placeholder="upstream"/>
                    </td>
                    <td>
                        >>
                    </td>
                    <td>
                        <input type="text"
                               className="form-control"
                               ref="inputDownstream"
                               placeholder="downstream"/>
                    </td>
                    <td>
                        <div className="btn-group">
                            <button className="btn btn-success" onClick={this.onBranchOk}>确定</button>
                            <button className="btn btn-default" onClick={this.changeEditable}>取消</button>
                        </div>
                    </td>
                </tr>);
            } else {
                return (<tr>
                    <td colSpan="5">
                        <button className="btn btn-default" onClick={this.changeEditable}>添加分支</button>
                    </td>
                </tr>);
            }
        },

        /**
         * 修改分支名确定
         */
        onBranchOk: function (event) {
            event.preventDefault();
            var txtUpstream = this.refs.inputUpstream.value.trim();
            var txtDownstream = this.refs.inputDownstream.value.trim();
            if (txtUpstream && txtDownstream) {
                var branch = {
                    downstream: txtDownstream,
                    upstream: txtUpstream,
                };
                this.props.list[this.props.data.key].push(branch);
                this.props.onChange(this.props.list);
                this.setState({
                    editable: false,
                });
            } else {
                return;
            }
        },

        /**
         * 删除分支
         * @param index
         */
        deleteBranch: function (index) {
            var branchList = this.props.list[this.props.data.key];
            var branchItem = branchList[index];
            var c = confirm('确定要删除[' + branchItem.upstream + '>>' + branchItem.downstream + ']？');
            if (c) {
                closeEditables();
                branchList.splice(index, 1);
                this.props.onChange(this.props.list);
            }
        },

        /**
         * 删除仓库
         */
        deleteRepo: function () {
            var repoName = this.props.data.key;
            var c = confirm('确定要删除[' + repoName + ']？');
            if (c) {
                closeEditables();
                delete this.props.list[repoName];
                this.props.onChange(this.props.list);
            }
        },

    });


    /**
     * 每个仓库名布局
     */
    var RepoName = React.createClass({
        mixins: [EditableMixIn],

        render: function () {
            var checked = this.props.data.checked ? true : false;
            if (this.state.editable) {
                return (<tr className="success">
                    <td>
                        <label>{this.props.index + 1}.</label>
                    </td>
                    <td colSpan="2">
                        <input type="text"
                               ref="inputRepoName"
                               className="form-control"
                               defaultValue={this.props.data.key}
                               placeholder="Path of repository"/>
                    </td>
                    <td>
                        <div className="btn-group">
                            <button className="btn btn-success" onClick={this.onRepoOk}>确定</button>
                            <button className="btn btn-default" onClick={this.changeEditable}>取消</button>
                        </div>
                    </td>
                </tr>);
            } else {
                return (<tr className="success">
                    <td>
                        <div class="checkbox">
                            <label>
                                <input type="checkbox"
                                       onChange={this.onCheckChange}
                                       checked={checked}/>
                                {this.props.index + 1}
                            </label>
                        </div>
                    </td>
                    <td colSpan="2">
                        <span onClick={this.changeEditable}>{this.props.data.key}</span>
                    </td>
                    <td>
                        <button className="btn btn-danger" onClick={this.deleteRepo}>X</button>
                    </td>
                </tr>);
            }
        },

        /**
         * 当checkbox发生改变时
         */
        onCheckChange: function (event) {
            let checked = event.target.checked;
            this.props.data.checked = checked;
            this.props.onChecked();
        },

        /**
         * 修改仓库名完成
         * @param event
         */
        onRepoOk: function (event) {
            event.preventDefault();
            var txtRepo = this.refs.inputRepoName.value.trim();
            if (txtRepo === '') {
                return;
            }
            if (txtRepo !== this.props.data.key) {
                this.props.list[txtRepo] = this.props.list[this.props.data.key];
                delete this.props.list[this.props.data.key];
                this.props.onChange(this.props.list);
            }
            this.setState({
                editable: false,
            });
        },

        /**
         * 删除仓库事件
         * @param event
         */
        deleteRepo: function (event) {
            event.preventDefault();
            this.props.deleteRepo();
        }
    });


    /**
     * 每个分支名布局
     */
    var BranchName = React.createClass({
        mixins: [EditableMixIn],

        render: function () {
            if (this.state.editable) {
                return (<tr>
                    <td className="col-xs-4">
                        <input type="text"
                               className="form-control"
                               defaultValue={this.props.branch.upstream}
                               ref="inputUpstream"
                               placeholder="upstream"/>
                    </td>
                    <td className="col-xs-2">>></td>
                    <td className="col-xs-4">
                        <input type="text"
                               className="form-control"
                               defaultValue={this.props.branch.downstream}
                               ref="inputDownstream"
                               placeholder="downstream"/>
                    </td>
                    <td className="col-xs-2">
                        <div className="btn-group">
                            <button className="btn btn-success" onClick={this.editBranchOk}>确定</button>
                            <button className="btn btn-default" onClick={this.changeEditable}>取消</button>
                        </div>
                    </td>
                </tr>);
            } else {
                return (<tr>
                    <td className="col-xs-4">
                        <span onClick={this.changeEditable}>{this.props.branch.upstream}</span>
                    </td>
                    <td className="col-xs-2">>></td>
                    <td className="col-xs-4">
                        <span onClick={this.changeEditable}>{this.props.branch.downstream}</span>
                    </td>
                    <td className="col-xs-2">
                        <button className="btn btn-warning" onClick={this.deleteBranch}>X</button>
                    </td>
                </tr>);
            }
        },

        /**
         * 分支名编辑完成
         * @param event
         */
        editBranchOk: function (event) {
            event.preventDefault();
            var txtUpstream = this.refs.inputUpstream.value.trim();
            var txtDownstream = this.refs.inputDownstream.value.trim();
            if (txtUpstream && txtDownstream) {
                var obj = this.props.list[this.props.data.key][this.props.index];
                obj.upstream = txtUpstream;
                obj.downstream = txtDownstream;
                this.props.onChange(this.props.list);
                this.setState({
                    editable: false,
                });
            } else {
                return;
            }
        },

        deleteBranch: function (event) {
            event.preventDefault();
            this.props.deleteBranch(this.props.index);
        }
    });

    var Styles = {
        centerText: {
            textAlign: 'center',
        }
    };

    /**
     * 渲染根节点
     */
    ReactDOM.render(<ContainerView/>,
            document.getElementById('container')
    );

</script>
<!--批量选择模态框-->
<div>
    <div class="modal fade" id="selectModal" tabindex="-1" role="dialog"
         aria-labelledby="selectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close"
                            data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title" id="selectModalLabel">
                        批量选择
                    </h4>
                </div>
                <div class="modal-body" style="padding-right:30px">
                    <label></label>
                    <label>输入要批量选择的库,以换行分隔(若不存在,将自动创建)</label>
                    <textarea id="selectModalContent"
                              class="form-control"
                              style="width:100%;resize: none"
                              rows="11"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default"
                            data-dismiss="modal">取消
                    </button>
                    <button type="button" class="btn btn-primary"
                            id="selectModalOk">
                        提交
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<!--提交模态框-->
<div>
    <div class="modal fade" id="commitModal" tabindex="-1" role="dialog"
         aria-labelledby="commitModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close"
                            data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title" id="commitModalLabel">
                        提交修改
                    </h4>
                </div>
                <div class="modal-body" style="padding-right:30px">
                    <div>
                        <label id="commitModalFileName"></label>
                        <label>结果预览:</label>
                    <pre id="diffPreview"
                         style="width:100%;resize: none; text-align:left; overflow: auto; height: 320px">
                    </pre>
                    </div>
                    <label>提交Log:</label>
                    <textarea id="commitModalLog"
                              class="form-control"
                              style="width:100%;resize: none"
                              placeholder="输入提交信息"
                              rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default"
                            data-dismiss="modal">取消
                    </button>
                    <button type="button" class="btn btn-primary"
                            id="commitModalOk">
                        提交
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<!--批量操作模态框-->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close"
                        data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel"></h4>
            </div>
            <div class="modal-body" id="myModalContent">
                <table class="table">
                    <thead>
                    <tr class="active">
                        <td colspan="2"><label>选择批量操作方式</label></td>
                        <td><select class="form-control" id="myModalSelect">
                            <option>添加分支</option>
                            <option>删除分支</option>
                        </select></td>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>
                            <input type="text"
                                   class="form-control"
                                   id="myModalUpStream"
                                   placeholder="upstream"/>
                        </td>
                        <td>>></td>
                        <td>
                            <input type="text"
                                   class="form-control"
                                   id="myModalDownStream"
                                   placeholder="downstream"/>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default"
                        data-dismiss="modal">取消
                </button>
                <button type="button" class="btn btn-primary" id="myModalCommit">
                    确定
                </button>
            </div>
        </div>
    </div>
</div>
</body>
</html>
